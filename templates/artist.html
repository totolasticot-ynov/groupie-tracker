<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>{{.Artist.Name}} - D√©tails</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* VARIABLES DE COULEURS */
        :root { --bg: #121212; --card: #181818; --accent: #1db954; --text: #fff; --subtext: #aaa; }
        
        body.light-mode {
            --bg: #e0e0e0; --card: #fff; --text: #000; --subtext: #666;
        }
        
        /* LAYOUT GENERAL */
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 40px 20px; display: flex; justify-content: center; transition: background 0.3s ease; }
        .container { width: 100%; max-width: 1200px; background: var(--card); border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.4); overflow: hidden; position: relative; transition: background 0.3s ease; }

        /* HEADER AVEC IMAGE DE FOND */
        .header { height: 400px; position: relative; display: flex; align-items: flex-end; padding: 40px; background: url('{{.Artist.Image}}') center/cover; }
        /* D√©grad√© pour lisibilit√© du texte */
        .header::after { content: ''; position: absolute; top:0; left:0; right:0; bottom:0; background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.9) 100%); pointer-events: none; }
        
        .header-content { position: relative; z-index: 2; display: flex; align-items: center; gap: 30px; animation: slideUp 0.8s ease; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .avatar { width: 200px; height: 200px; border-radius: 50%; border: 5px solid var(--card); box-shadow: 0 10px 30px rgba(0,0,0,0.5); object-fit: cover; transition: border-color 0.3s; }
        
        /* Textes Header toujours blancs √† cause du fond image */
        h1 { font-size: 4rem; margin: 0; line-height: 1; letter-spacing: -2px; color: #fff; }
        .meta-info { margin-top: 10px; color: rgba(255,255,255,0.8); }
        .members-list { margin-top: 15px; }
        .members-list span { color: rgba(255,255,255,0.6); margin-right: 10px; font-size: 0.9rem; }

        /* BOUTON RETOUR */
        .back-btn { position: absolute; top: 30px; left: 30px; z-index: 10; background: rgba(0,0,0,0.6); color: white; padding: 10px 20px; border-radius: 30px; text-decoration: none; font-weight: bold; backdrop-filter: blur(5px); transition: 0.3s; border: 1px solid rgba(255,255,255,0.1); }
        .back-btn:hover { background: var(--accent); color: black; border-color: var(--accent); }

        /* GRILLE DE CONTENU */
        .content { display: grid; grid-template-columns: 1fr 1.5fr; gap: 40px; padding: 40px; }
        h2 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 20px; color: var(--accent); text-transform: uppercase; font-size: 0.9rem; letter-spacing: 2px; }

        /* LISTE DES CONCERTS */
        .concert-list { list-style: none; padding: 0; max-height: 600px; overflow-y: auto; padding-right: 10px; }
        
        /* Scrollbar moderne (Webkit) */
        .concert-list::-webkit-scrollbar { width: 6px; }
        .concert-list::-webkit-scrollbar-track { background: transparent; }
        .concert-list::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .concert-list::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        .concert-item { background: rgba(255,255,255,0.03); margin-bottom: 15px; padding: 20px; border-radius: 12px; border-left: 4px solid transparent; transition: 0.3s; opacity: 0; animation: fadeInItem 0.5s ease forwards; }
        /* Animation en cascade (stagger) */
        .concert-item:nth-child(1) { animation-delay: 0.1s; }
        .concert-item:nth-child(2) { animation-delay: 0.2s; }
        .concert-item:nth-child(3) { animation-delay: 0.3s; }
        .concert-item:nth-child(n+4) { animation-delay: 0.4s; }

        .concert-item:hover { background: rgba(255,255,255,0.08); border-left-color: var(--accent); transform: translateX(5px); }
        
        /* Ajustement mode clair pour la liste */
        body.light-mode .concert-item { background: #f5f5f5; border: 1px solid #ddd; }
        body.light-mode .concert-item:hover { background: #e9e9e9; }

        .city { font-size: 1.1rem; font-weight: bold; color: var(--text); text-transform: capitalize; }
        .dates span { display: inline-block; background: var(--bg); color: var(--subtext); padding: 5px 10px; border-radius: 5px; margin: 5px 5px 0 0; font-size: 0.85rem; border: 1px solid rgba(128,128,128,0.2); }
        
        /* CARTE & LOADING */
        #map { height: 600px; width: 100%; border-radius: 20px; opacity: 0; animation: fadeIn 1s 0.5s forwards; z-index: 1; }
        .loading { text-align: center; color: var(--subtext); font-style: italic; margin-top: 10px; font-size: 0.9rem; min-height: 20px; transition: color 0.3s; }
        
        .no-data { background: rgba(255,0,0,0.1); padding: 20px; border-radius: 10px; text-align: center; color: #ff6b6b; border: 1px dashed #ff6b6b; }

        /* BOUTON THEME */
        .theme-toggle { position: fixed; top: 20px; right: 20px; z-index: 10000; background: var(--accent); border: none; color: #000; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(29, 185, 84, 0.3); }
        .theme-toggle:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(29, 185, 84, 0.5); }

        /* ANIMATIONS */
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes fadeInItem { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle" title="Changer le th√®me">üåô</button>
    
    <div class="container">
        <a href="/" class="back-btn">‚Üê Retour</a>

        <div class="header">
            <div class="header-content">
                <img src="{{.Artist.Image}}" class="avatar" alt="Artist Image">
                <div>
                    <h1>{{.Artist.Name}}</h1>
                    <div class="meta-info">
                        <span>Cr√©√© en {{.Artist.CreationDate}}</span> ‚Ä¢ <span>1er Album : {{.Artist.FirstAlbum}}</span>
                    </div>
                    <div class="members-list">
                        {{ range .Artist.Members }}<span>#{{.}}</span>{{ end }}
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <div>
                <h2>Concerts √† venir</h2>
                {{ if .Relations.DatesLocations }}
                    <ul class="concert-list">
                        {{ range $key, $val := .Relations.DatesLocations }}
                            <li class="concert-item">
                                <div class="city">{{ $key }}</div> 
                                <div class="dates">{{ range $val }}<span>{{ . }}</span>{{ end }}</div>
                            </li>
                        {{ end }}
                    </ul>
                {{ else }}
                    <div class="no-data">
                        Aucune date disponible pour le moment.
                    </div>
                {{ end }}
            </div>
            
            <div>
                <h2>Carte de la tourn√©e</h2>
                <div id="map"></div>
                <p class="loading" id="status">Initialisation de la carte...</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="application/json" id="locations-data">{{ .LocationsJson }}</script>
    
    <script>
        // --- 1. CONFIGURATION DE LA CARTE ---
        var map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            maxZoom: 18, 
            attribution: '¬© OpenStreetMap' 
        }).addTo(map);

        // --- 2. RECUPERATION DES DONNEES ---
        var rawLocations = JSON.parse(document.getElementById('locations-data').textContent);
        const statusText = document.getElementById('status');
        let markersGroup = []; // Pour stocker les marqueurs et zoomer dessus plus tard

        // --- 3. FONCTION DE GEOLOCALISATION ---
        async function pinLocations() {
            if(!rawLocations || rawLocations.length === 0) { 
                statusText.innerText = "Aucune donn√©e de localisation."; 
                return; 
            }
            
            // Nettoyage visuel des noms de villes dans la liste HTML (Optionnel mais joli)
            document.querySelectorAll('.city').forEach(el => {
                el.textContent = el.textContent.replace(/-/g, ', ').replace(/_/g, ' ');
            });

            for (let loc of rawLocations) {
                // Nettoyage pour l'API : new_york-usa -> new york, usa
                let query = loc.replace(/-/g, ', ').replace(/_/g, ' ');
                
                statusText.innerText = "Recherche : " + query + "...";
                
                try {
                    // Appel API Nominatim
                    let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
                    let data = await res.json();
                    
                    if (data.length > 0) {
                        let lat = data[0].lat;
                        let lon = data[0].lon;
                        
                        // Cr√©ation du marqueur
                        let marker = L.marker([lat, lon]).addTo(map);
                        
                        // Popup stylis√©e
                        marker.bindPopup(`<div style="text-transform:capitalize; font-weight:bold;">${query}</div>`);
                        
                        markersGroup.push(marker);
                    }
                } catch(e) {
                    console.error("Erreur g√©ocodage:", e);
                }
                
                // Petit d√©lai pour ne pas spammer l'API (Respect des conditions d'utilisation)
                await new Promise(r => setTimeout(r, 600)); 
            }
            
            statusText.innerText = ""; // Effacer le message de chargement
            
            // --- 4. AUTO-ZOOM FINAL ---
            if (markersGroup.length > 0) {
                // Cr√©e un groupe Leaflet et ajuste la vue pour tout voir
                let group = new L.featureGroup(markersGroup);
                map.fitBounds(group.getBounds(), { padding: [50, 50] });
            }
        }
        
        // Lancer le processus
        pinLocations();

        // --- 5. GESTION DU THEME (Sombre/Clair) ---
        const themeToggle = document.getElementById('themeToggle');
        const savedTheme = localStorage.getItem('theme') || 'dark';
        
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            themeToggle.textContent = '‚òÄÔ∏è';
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            themeToggle.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
        });
    </script>
</body>
</html>
